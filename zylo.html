<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZIPPY</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #fff;
      color: #222;
      overflow: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark {
      background-color: #121212;
      color: #ddd;
    }
    #chatContainer {
      background: inherit;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      transition: background-color 0.3s ease;
    }
    header {
      background: transparent;
      border-bottom: 1px solid #e5e5e5;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      flex-shrink: 0;
      transition: border-color 0.3s ease;
    }
    body.dark header {
      border-color: #333;
    }
    header h1 {
      font-weight: 700;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      letter-spacing: 0.05em;
      color: inherit;
    }
    header h1 i {
      font-size: 1.8rem;
    }
    #settingsBtn {
      background: transparent;
      border: none;
      color: inherit;
      font-size: 1.5rem;
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }
    #settingsBtn:hover,
    #settingsBtn:focus {
      color: #555;
      outline: none;
    }
    body.dark #settingsBtn:hover,
    body.dark #settingsBtn:focus {
      color: #bbb;
    }
    #chatMessages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1.5rem 1.5rem 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      scrollbar-width: thin;
      scrollbar-color: #aaa transparent;
      scroll-behavior: smooth;
      background: inherit;
      font-size: 1rem;
      line-height: 1.5;
      position: relative;
      padding-bottom: 140px; /* increased padding bottom for spacing */
      word-break: break-word;
      max-width: 100%;
      transition: color 0.3s ease;
    }
    #chatMessages::-webkit-scrollbar {
      width: 8px;
    }
    #chatMessages::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 8px;
    }
    #chatMessages::-webkit-scrollbar-thumb {
      background-color: #aaa;
      border-radius: 8px;
    }
    body.dark #chatMessages::-webkit-scrollbar-thumb {
      background-color: #666;
    }
    .fade-in-up {
      animation: fadeInUp 0.3s ease forwards;
    }
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(6px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .message {
      max-width: 70ch;
      padding: 1rem 1.5rem;
      border-radius: 1rem;
      user-select: text;
      font-size: 1rem;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      position: relative;
      background-clip: padding-box;
      word-break: break-word;
      hyphens: auto;
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
      color: #222;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark .message {
      background-color: #2a2a2a;
      color: #ddd;
    }
    .message.bot {
      align-self: flex-start;
      margin-left: 1.5rem;
      margin-right: 3rem;
      border-top-left-radius: 0.25rem;
      border-top-right-radius: 1rem;
      border-bottom-left-radius: 1rem;
      border-bottom-right-radius: 1rem;
    }
    .message.user {
      align-self: flex-end;
      margin-right: 1.5rem;
      margin-left: 3rem;
      background-color: #444;
      color: #eee;
      border-top-right-radius: 0.25rem;
      border-top-left-radius: 1rem;
      border-bottom-left-radius: 1rem;
      border-bottom-right-radius: 1rem;
    }
    body.dark .message.user {
      background-color: #4f4f4f;
      color: #eee;
    }
    #inputModal {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #f5f5f5;
      padding: 0.5rem 1rem;
      border-radius: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 65vw; /* reduced width from 70vw to 65vw */
      max-width: 550px; /* reduced max width from 600px to 550px */
      z-index: 30;
      border: 1px solid #ccc;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      flex-shrink: 0;
      box-sizing: border-box;
    }
    body.dark #inputModal {
      background: #2a2a2a;
      border-color: #555;
    }
    #inputModal:focus-within {
      border-color: #888;
    }
    #inputWrapper {
      flex-grow: 1;
      display: flex;
      align-items: center;
    }
    #pergunta {
      width: 100%;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      border: 1px solid #ccc;
      font-size: 1rem;
      color: #222;
      background-color: #fff;
      transition: border-color 0.2s ease, background-color 0.3s ease, color 0.3s ease;
      max-width: 50ch;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-break: break-word;
      font-weight: 400;
      font-family: 'Inter', sans-serif;
    }
    body.dark #pergunta {
      border-color: #555;
      background-color: #3a3a3a;
      color: #ddd;
    }
    #pergunta::placeholder {
      color: #999;
    }
    #pergunta:focus {
      outline: none;
      border-color: #888;
      background-color: #fff;
      color: #222;
    }
    body.dark #pergunta:focus {
      border-color: #aaa;
      background-color: #444;
      color: #eee;
    }
    #webToggleBtn {
      background-color: transparent;
      border: 1px solid #ccc;
      border-radius: 0.75rem;
      width: 40px;
      height: 40px;
      cursor: pointer;
      color: #444;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      flex-shrink: 0;
    }
    body.dark #webToggleBtn {
      border-color: #555;
      color: #ddd;
    }
    #webToggleBtn.active {
      background-color: #444;
      border-color: #444;
      color: #fff;
    }
    body.dark #webToggleBtn.active {
      background-color: #ddd;
      border-color: #ddd;
      color: #222;
    }
    #webToggleBtn:focus-visible {
      outline: 2px solid #888;
      outline-offset: 2px;
    }
    body.dark #webToggleBtn:focus-visible {
      outline: 2px solid #aaa;
      outline-offset: 2px;
    }
    #enviarBtn {
      background-color: #444;
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      flex-shrink: 0;
      user-select: none;
      min-width: 44px;
      min-height: 40px;
    }
    body.dark #enviarBtn {
      background-color: #ddd;
      color: #222;
    }
    #enviarBtn:hover:not(:disabled) {
      background-color: #666;
    }
    body.dark #enviarBtn:hover:not(:disabled) {
      background-color: #bbb;
    }
    #enviarBtn:active:not(:disabled) {
      background-color: #333;
    }
    body.dark #enviarBtn:active:not(:disabled) {
      background-color: #999;
    }
    #enviarBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #settingsModal {
      position: fixed;
      top: 12vh;
      right: 1.5rem;
      height: auto;
      width: 320px;
      max-width: 90vw;
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
      padding: 1.5rem 1.5rem 2.5rem 1.5rem;
      z-index: 50;
      display: none;
      flex-direction: column;
      gap: 1rem;
      color: #222;
      user-select: none;
      font-size: 1rem;
      overflow-y: visible;
      opacity: 0;
      transform: translateX(110%);
      transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      border-radius: 1rem;
      font-family: 'Inter', sans-serif;
    }
    body.dark #settingsModal {
      background: #1e1e1e;
      border-color: #444;
      box-shadow: 0 0 20px rgb(0 0 0 / 0.6);
      color: #ddd;
    }
    #settingsModal.active {
      display: flex;
      opacity: 1;
      transform: translateX(0);
    }
    #settingsModal h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 1rem 0;
      user-select: text;
      text-align: center;
      letter-spacing: 0.05em;
    }
    #settingsModal .email-display {
      font-size: 0.9rem;
      background: #f5f5f5;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      user-select: text;
      word-break: break-all;
      text-align: center;
      margin-bottom: 0;
      max-height: 3rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: 'Inter', sans-serif;
      font-weight: 400;
      border: 1px solid #ddd;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }
    body.dark #settingsModal .email-display {
      background: #2a2a2a;
      border-color: #444;
      color: #ddd;
    }
    #clearHistoryBtn, #disconnectBtn {
      background-color: #e53e3e;
      border: none;
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 700;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      font-size: 0.95rem;
      width: 100%;
      font-family: 'Inter', sans-serif;
      transition: background-color 0.2s ease;
    }
    #clearHistoryBtn:hover {
      background-color: #c53030;
    }
    #clearHistoryBtn:active {
      background-color: #9b2c2c;
    }
    #disconnectBtn {
      background-color: #444;
      color: #ddd;
      margin-top: 0.5rem;
      font-weight: 600;
    }
    body.dark #disconnectBtn {
      background-color: #555;
      color: #ddd;
    }
    #disconnectBtn:hover {
      background-color: #333;
    }
    #disconnectBtn:active {
      background-color: #222;
    }
    #settingsCloseBtn {
      position: absolute;
      top: 0.75rem;
      right: 1rem;
      background: transparent;
      border: none;
      color: inherit;
      font-size: 1.5rem;
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      z-index: 60;
    }
    #settingsCloseBtn:hover,
    #settingsCloseBtn:focus {
      color: #555;
      outline: none;
    }
    body.dark #settingsCloseBtn:hover,
    body.dark #settingsCloseBtn:focus {
      color: #bbb;
    }
    #settingsVersion {
      font-size: 0.85rem;
      color: #666;
      text-align: center;
      user-select: text;
      margin-top: 1rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      font-family: 'Inter', sans-serif;
    }
    body.dark #settingsVersion {
      color: #999;
    }
    /* Toggle switch styles */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      display: inline-block;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 9999px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #10a37f;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    /* Responsive */
    @media (max-width: 1024px) {
      #chatContainer {
        height: 100vh;
        width: 100vw;
        max-width: 100vw;
      }
      header {
        padding: 1rem 1.25rem;
      }
      header h1 {
        font-size: 1.25rem;
      }
      #settingsBtn {
        font-size: 1.4rem;
      }
      #inputModal {
        width: 75vw; /* adjusted from 80vw */
        max-width: 480px; /* reduced max width */
        padding: 0.5rem 1rem;
        bottom: 20px;
      }
      #pergunta {
        font-size: 1rem;
        max-width: 40ch;
      }
      #webToggleBtn {
        width: 36px;
        height: 36px;
        font-size: 1.1rem;
      }
      #enviarBtn {
        font-size: 1.1rem;
        padding: 0.45rem 1rem;
        min-width: 40px;
        min-height: 36px;
      }
    }
    @media (max-width: 640px) {
      body {
        padding: 0.5rem;
      }
      #chatContainer {
        height: 100vh;
        width: 100vw;
        max-width: 100vw;
      }
      header {
        padding: 0.75rem 1rem;
      }
      header h1 {
        font-size: 1.125rem;
      }
      #settingsBtn {
        font-size: 1.2rem;
      }
      #chatMessages {
        padding: 1rem 1rem 1rem 1rem;
        font-size: 0.95rem;
      }
      .message {
        max-width: 90vw;
        font-size: 0.95rem;
      }
      #inputModal {
        width: 100vw;
        max-width: 100vw;
        border-radius: 0;
        bottom: 0;
        left: 0;
        transform: none;
        padding: 0.5rem 1rem;
        box-shadow: none;
        border: none;
      }
      #pergunta {
        font-size: 0.95rem;
        padding: 0.4rem 1rem;
        max-width: 100%;
      }
      #webToggleBtn {
        width: 32px;
        height: 32px;
        font-size: 1rem;
        border-radius: 0.5rem;
      }
      #enviarBtn {
        font-size: 1.1rem;
        padding: 0.4rem 0.9rem;
        border-radius: 0.5rem;
        min-width: 36px;
        min-height: 32px;
      }
      #settingsModal {
        top: 0;
        right: 0;
        width: 100vw;
        height: 100vh;
        max-width: 100vw;
        border-radius: 0;
        border: none;
        box-shadow: none;
        padding: 2rem 1.5rem 3rem 1.5rem;
        transform: translateX(100%);
        overflow-y: auto;
      }
      #settingsModal.active {
        transform: translateX(0);
      }
      #settingsCloseBtn {
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
      }
      #clearHistoryBtn, #disconnectBtn {
        font-size: 1rem;
      }
      #settingsVersion {
        margin-top: 1.5rem;
      }
    }
    /* Custom toast container and toast styles */
    #toastContainer {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 90vw;
      width: auto;
      pointer-events: none;
      align-items: center;
    }
    .toast {
      pointer-events: auto;
      background-color: #333;
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.3);
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      max-width: 100%;
      word-break: break-word;
      opacity: 0;
      transform: translateY(20px);
      animation: toastIn 0.3s forwards, toastOut 0.3s forwards 3.7s;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .toast.success {
      background-color: #10a37f;
    }
    .toast.error {
      background-color: #e53e3e;
    }
    .toast .close-btn {
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
      color: white;
      background: transparent;
      border: none;
      padding: 0;
      margin-left: auto;
      user-select: none;
      transition: color 0.2s ease;
    }
    .toast .close-btn:hover,
    .toast .close-btn:focus {
      color: #ddd;
      outline: none;
    }
    @keyframes toastIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes toastOut {
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }
  </style>
</head>
<body>
  <div id="chatContainer" role="main" aria-label="Chat ZIPPY Interface Simples">
    <header>
      <h1>
        <i class="fas fa-robot" aria-hidden="true"></i>
        ZIPPY
      </h1>
      <button id="settingsBtn" aria-label="Abrir configurações" title="Configurações" type="button">
        <i class="fas fa-cog" aria-hidden="true"></i>
      </button>
      <nav aria-label="Ações do chat" hidden>
      </nav>
    </header>

    <main id="chatMessages" role="log" aria-live="polite" aria-relevant="additions" tabindex="0">
    </main>

    <form id="inputModal" autocomplete="off" onsubmit="return false" aria-label="Enviar mensagem">
      <button
        id="webToggleBtn"
        type="button"
        aria-pressed="false"
        aria-label="Ativar pesquisa na web"
        title="Ativar pesquisa na web"
        tabindex="0"
      >
        <i class="fas fa-globe-americas"></i>
      </button>
      <div id="inputWrapper">
        <input
          id="pergunta"
          type="text"
          placeholder="Digite sua mensagem..."
          aria-label="Digite sua mensagem"
          spellcheck="false"
          autocomplete="off"
          maxlength="4000"
          autofocus
          aria-disabled="true"
          tabindex="0"
        />
      </div>
      <button id="enviarBtn" type="submit" aria-label="Enviar mensagem" disabled tabindex="0">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>

    <section id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" tabindex="-1">
      <button id="settingsCloseBtn" aria-label="Fechar configurações" title="Fechar configurações" type="button">
        <i class="fas fa-times"></i>
      </button>
      <h2 id="settingsTitle">ZIPPY</h2>
      <div id="userEmail" class="email-display" tabindex="0" aria-readonly="true"></div>
      <button id="clearHistoryBtn" type="button" aria-label="Limpar histórico de mensagens" title="Limpar histórico de mensagens">
        <i class="fas fa-trash-alt"></i> Limpar histórico
      </button>

      <label for="themeToggleSwitch" class="flex items-center cursor-pointer select-none gap-2">
        <span>Tema claro</span>
        <div class="toggle-switch">
          <input type="checkbox" id="themeToggleSwitch" aria-label="Alternar tema claro/escuro" />
          <span class="slider"></span>
        </div>
        <span>Escuro</span>
      </label>

      <button id="disconnectBtn" type="button" aria-label="Desconectar da conta" title="Desconectar da conta">
        <i class="fas fa-sign-out-alt"></i> Desconectar
      </button>
      <div id="settingsVersion">BETA 0.0.9</div>
    </section>

    <div id="toastContainer" aria-live="assertive" aria-atomic="true"></div>
  </div>

  <script>
    // Toast system to replace alert()
    const toastContainer = document.getElementById('toastContainer');

    function showToast(message, type = 'error', duration = 4000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');

      const msgSpan = document.createElement('span');
      msgSpan.textContent = message;
      toast.appendChild(msgSpan);

      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-btn';
      closeBtn.setAttribute('aria-label', 'Fechar notificação');
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = () => {
        toastContainer.removeChild(toast);
      };
      toast.appendChild(closeBtn);

      toastContainer.appendChild(toast);

      setTimeout(() => {
        if (toast.parentNode) {
          toast.classList.add('hide');
          toast.addEventListener('animationend', () => {
            if (toast.parentNode) toastContainer.removeChild(toast);
          });
        }
      }, duration);
    }

    // Redirect user to login page if not logged in
    function redirectToLogin() {
      // Detect if device is mobile or desktop
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (isMobile) {
        window.location.href = 'login/movel.html';
      } else {
        window.location.href = 'login/desktop.html';
      }
    }

    // Check user login on load
    window.addEventListener('load', () => {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.id || !user.email) {
        redirectToLogin();
        return;
      }
      const inputModal = document.getElementById('inputModal');
      const chatMessages = document.getElementById('chatMessages');
      if (inputModal && chatMessages) {
        const inputRect = inputModal.getBoundingClientRect();
        chatMessages.style.paddingBottom = `${inputRect.height + 60}px`;
      }
      loadMessagesFromStorage();
      loadUserEmail();
      loadThemeFromStorage();
    });

    
    const chatMessages = document.getElementById("chatMessages");
    const perguntaInput = document.getElementById("pergunta");
    const enviarBtn = document.getElementById("enviarBtn");
    const webToggleBtn = document.getElementById("webToggleBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsModal = document.getElementById("settingsModal");
    const settingsCloseBtn = document.getElementById("settingsCloseBtn");
    const userEmailDisplay = document.getElementById("userEmail");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const themeToggleSwitch = document.getElementById("themeToggleSwitch");
    const body = document.body;

    let isTypingResponse = false;

    function getChatHistoryKey(userId) {
      return `chatMessages_${userId}`;
    }

    async function loadMessagesFromStorage() {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.id || !user.email) return;
      const key = getChatHistoryKey(user.id);
      const saved = localStorage.getItem(key);
      if (!saved) {
        try {
          const response = await fetch(`https://api-zylo.doshi.icu:8080/historico?email=${encodeURIComponent(user.email)}`);
          if (!response.ok) throw new Error(`Erro ao buscar histórico! Status: ${response.status}`);
          const data = await response.json();
          if (data && Array.isArray(data.historico)) {
            const messages = data.historico.map(item => {
              const html = parseMarkdown(item.text);
              return {
                html: html,
                fromUser: item.role === "user"
              };
            });
            localStorage.setItem(key, JSON.stringify(messages));
            messages.forEach(({ html, fromUser }) => {
              addMessageFromHTML(html, fromUser, false);
            });
            setTimeout(() => {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 50);
          }
        } catch (error) {
          console.error("Erro ao carregar histórico do servidor:", error);
          showToast("Erro ao carregar histórico do servidor.", "error");
        }
      } else {
        try {
          const messages = JSON.parse(saved);
          if (!Array.isArray(messages)) return;
          messages.forEach(({ html, fromUser }) => {
            addMessageFromHTML(html, fromUser, false);
          });
          setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 50);
        } catch {
          showToast("Erro ao carregar histórico local.", "error");
        }
      }
    }

    function saveMessagesToStorage() {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.id) return;
      const key = getChatHistoryKey(user.id);
      const messages = [];
      chatMessages.querySelectorAll(".message").forEach((msgEl) => {
        const fromUser = msgEl.classList.contains("user");
        const html = msgEl.innerHTML || "";
        messages.push({ html, fromUser });
      });
      localStorage.setItem(key, JSON.stringify(messages));
    }

    webToggleBtn.addEventListener("click", () => {
      if (isTypingResponse) return; // block toggle while typing
      const active = webToggleBtn.classList.toggle("active");
      webToggleBtn.setAttribute("aria-pressed", active ? "true" : "false");
      updateEnviarBtnState();
    });

    function updateEnviarBtnState() {
      const val = perguntaInput.value.trim();
      if (val.length === 0 || val.length > 4000 || isTypingResponse) {
        enviarBtn.disabled = true;
        perguntaInput.setAttribute("aria-disabled", "true");
      } else {
        enviarBtn.disabled = false;
        perguntaInput.setAttribute("aria-disabled", "false");
      }
    }

    perguntaInput.addEventListener("input", updateEnviarBtnState);

    function parseMarkdown(text) {
      const escapeHtml = (str) =>
        str.replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#39;");

      let escapedText = escapeHtml(text);

      escapedText = escapedText.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      escapedText = escapedText.replace(/\*(.+?)\*/g, '<em>$1</em>');
      escapedText = escapedText.replace(/\\n/g, '<br>');

      return escapedText;
    }

    function addMessage(text, fromUser = false, save = true) {
      const messageWrapper = document.createElement("div");
      messageWrapper.classList.add("fade-in-up", "message");
      if (fromUser) {
        messageWrapper.classList.add("user");
        messageWrapper.textContent = text;
      } else {
        messageWrapper.classList.add("bot");
        messageWrapper.innerHTML = parseMarkdown(text);
      }
      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      if (save) saveMessagesToStorage();
    }

    function addMessageFromHTML(html, fromUser = false, save = true) {
      const messageWrapper = document.createElement("div");
      messageWrapper.classList.add("fade-in-up", "message");
      if (fromUser) {
        messageWrapper.classList.add("user");
        messageWrapper.innerHTML = html;
      } else {
        messageWrapper.classList.add("bot");
        messageWrapper.innerHTML = html;
      }
      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      if (save) saveMessagesToStorage();
    }

    async function typeMessage(text) {
      isTypingResponse = true;
      updateEnviarBtnState();

      const messageWrapper = document.createElement("div");
      messageWrapper.classList.add("fade-in-up", "message", "bot");

      messageWrapper.innerHTML = parseMarkdown(text);

      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      saveMessagesToStorage();

      await new Promise(resolve => setTimeout(resolve, 50));

      isTypingResponse = false;
      updateEnviarBtnState();
    }

    async function sendMessage() {
      if (isTypingResponse) return;

      const pergunta = perguntaInput.value.trim();
      if (!pergunta) {
        showToast("Por favor, digite uma pergunta.", "error");
        return;
      }

      addMessage(pergunta, true);
      perguntaInput.value = "";
      updateEnviarBtnState();
      enviarBtn.disabled = true;

      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.email) {
        showToast("Usuário não encontrado no localStorage.", "error");
        enviarBtn.disabled = false;
        return;
      }

      const email = user.email;
      const web = webToggleBtn.classList.contains("active") ? "on" : "off";

      const loadingMessage = document.createElement("div");
      loadingMessage.classList.add(
        "fade-in-up",
        "message",
        "bot"
      );
      loadingMessage.textContent = web === "on" ? "Buscando na web..." : "Pensando...";
      chatMessages.appendChild(loadingMessage);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      saveMessagesToStorage();

      try {
        const payload = {
          email: email,
          pergunta: pergunta,
          web: web,
        };

        const response = await fetch("https://api-zylo.doshi.icu:8080/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`Erro na requisição! Status: ${response.status}`);
        }

        const data = await response.json();

        chatMessages.removeChild(loadingMessage);
        saveMessagesToStorage();

        await typeMessage(data.resposta || "Sem resposta.");
      } catch (err) {
        console.error("Erro:", err);

        chatMessages.removeChild(loadingMessage);
        saveMessagesToStorage();

        await typeMessage("Erro ao conectar com a API.");
      } finally {
        enviarBtn.disabled = false;
      }
    }

    // Custom confirm dialog replaced by customConfirm function (already implemented)

    function customConfirm(message) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = 0;
        overlay.style.left = 0;
        overlay.style.width = '100vw';
        overlay.style.height = '100vh';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.3)';
        overlay.style.zIndex = 1000;
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';

        const modal = document.createElement('div');
        modal.style.backgroundColor = body.classList.contains('dark') ? '#2a2a2a' : '#fff';
        modal.style.padding = '1.5rem 2rem';
        modal.style.borderRadius = '1rem';
        modal.style.boxShadow = '0 0 15px rgb(0 0 0 / 0.15)';
        modal.style.maxWidth = '320px';
        modal.style.width = '90vw';
        modal.style.color = body.classList.contains('dark') ? '#ddd' : '#222';
        modal.style.fontFamily = "'Inter', sans-serif";
        modal.style.textAlign = 'center';
        modal.style.userSelect = 'none';
        modal.style.fontWeight = '600';

        const msg = document.createElement('p');
        msg.textContent = message;
        msg.style.marginBottom = '1.5rem';
        msg.style.fontSize = '1rem';
        modal.appendChild(msg);

        const btnContainer = document.createElement('div');
        btnContainer.style.display = 'flex';
        btnContainer.style.justifyContent = 'center';
        btnContainer.style.gap = '1rem';

        const btnConfirm = document.createElement('button');
        btnConfirm.textContent = 'Sim';
        btnConfirm.style.backgroundColor = '#10a37f';
        btnConfirm.style.color = 'white';
        btnConfirm.style.border = 'none';
        btnConfirm.style.padding = '0.5rem 1.25rem';
        btnConfirm.style.borderRadius = '0.5rem';
        btnConfirm.style.cursor = 'pointer';
        btnConfirm.style.fontWeight = '700';
        btnConfirm.style.fontFamily = "'Inter', sans-serif";
        btnConfirm.addEventListener('mouseenter', () => {
          btnConfirm.style.backgroundColor = '#0e8f6e';
        });
        btnConfirm.addEventListener('mouseleave', () => {
          btnConfirm.style.backgroundColor = '#10a37f';
        });

        const btnCancel = document.createElement('button');
        btnCancel.textContent = 'Não';
        btnCancel.style.backgroundColor = '#e53e3e';
        btnCancel.style.color = 'white';
        btnCancel.style.border = 'none';
        btnCancel.style.padding = '0.5rem 1.25rem';
        btnCancel.style.borderRadius = '0.5rem';
        btnCancel.style.cursor = 'pointer';
        btnCancel.style.fontWeight = '700';
        btnCancel.style.fontFamily = "'Inter', sans-serif";
        btnCancel.addEventListener('mouseenter', () => {
          btnCancel.style.backgroundColor = '#c53030';
        });
        btnCancel.addEventListener('mouseleave', () => {
          btnCancel.style.backgroundColor = '#e53e3e';
        });

        btnConfirm.addEventListener('click', () => {
          document.body.removeChild(overlay);
          resolve(true);
        });
        btnCancel.addEventListener('click', () => {
          document.body.removeChild(overlay);
          resolve(false);
        });

        btnContainer.appendChild(btnConfirm);
        btnContainer.appendChild(btnCancel);
        modal.appendChild(btnContainer);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        btnConfirm.focus();

        function onKeyDown(e) {
          if (e.key === "Escape") {
            e.preventDefault();
            document.body.removeChild(overlay);
            resolve(false);
            window.removeEventListener('keydown', onKeyDown);
          }
        }
        window.addEventListener('keydown', onKeyDown);
      });
    }

    enviarBtn.addEventListener("click", (e) => {
      e.preventDefault();
      sendMessage();
    });

    perguntaInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (!enviarBtn.disabled) {
          sendMessage();
        }
      }
    });

    const observer = new MutationObserver(() => {
      const inputModal = document.getElementById('inputModal');
      const chatMessages = document.getElementById('chatMessages');
      if (inputModal && chatMessages) {
        const inputRect = inputModal.getBoundingClientRect();
        chatMessages.style.paddingBottom = `${inputRect.height + 60}px`; /* increased gap */
      }
    });
    observer.observe(document.getElementById('chatMessages'), { childList: true, subtree: true });

    window.addEventListener('resize', () => {
      const inputModal = document.getElementById('inputModal');
      const chatMessages = document.getElementById('chatMessages');
      if (inputModal && chatMessages) {
        const inputRect = inputModal.getBoundingClientRect();
        chatMessages.style.paddingBottom = `${inputRect.height + 60}px`;
      }
    });

    function openSettings() {
      settingsModal.classList.add("active");
      settingsModal.focus();
    }
    function closeSettings() {
      settingsModal.classList.remove("active");
      settingsBtn.focus();
    }

    settingsBtn.addEventListener("click", () => {
      if (settingsModal.classList.contains("active")) {
        closeSettings();
      } else {
        openSettings();
      }
    });

    settingsCloseBtn.addEventListener("click", () => {
      closeSettings();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && settingsModal.classList.contains("active")) {
        e.preventDefault();
        closeSettings();
      }
    });

    function loadUserEmail() {
      const user = JSON.parse(localStorage.getItem("user"));
      if (user && user.email) {
        userEmailDisplay.textContent = user.email;
      } else {
        userEmailDisplay.textContent = "Usuário não encontrado";
      }
    }

    clearHistoryBtn.addEventListener("click", async () => {
      const confirmed = await customConfirm("Tem certeza que deseja limpar o histórico de mensagens?");
      if (!confirmed) return;

      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.email || !user.id) {
        showToast("Usuário não encontrado no localStorage.", "error");
        return;
      }
      const email = encodeURIComponent(user.email);
      try {
        const response = await fetch(`https://api-zylo.doshi.icu:8080/apagar-historico?email=${email}`, {
          method: "DELETE",
        });
        if (!response.ok) {
          throw new Error(`Erro ao apagar histórico! Status: ${response.status}`);
        }
        const key = getChatHistoryKey(user.id);
        localStorage.removeItem(key);
        while (chatMessages.firstChild) {
          chatMessages.removeChild(chatMessages.firstChild);
        }
        closeSettings();
        showToast("Histórico apagado com sucesso.", "success");
      } catch (error) {
        showToast("Erro ao apagar histórico: " + error.message, "error");
      }
    });

    disconnectBtn.addEventListener("click", async () => {
      const confirmed = await customConfirm("Tem certeza que deseja desconectar da conta?");
      if (!confirmed) return;

      localStorage.removeItem("user");
      redirectToLogin();
    });

    // Theme toggle logic with switch input
    function setTheme(dark) {
      if (dark) {
        body.classList.add('dark');
        themeToggleSwitch.checked = true;
        localStorage.setItem('theme', 'dark');
      } else {
        body.classList.remove('dark');
        themeToggleSwitch.checked = false;
        localStorage.setItem('theme', 'light');
      }
    }

    function loadThemeFromStorage() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        setTheme(true);
      } else {
        setTheme(false);
      }
    }

    themeToggleSwitch.addEventListener('change', () => {
      setTheme(themeToggleSwitch.checked);
    });

    updateEnviarBtnState();
  </script>
</body>
</html>
