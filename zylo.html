<!DOCTYPE html>

<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ZIPPY</title>

  <link rel="apple-touch-icon" sizes="180x180" href="/imagem/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/imagem/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/imagem/favicon-16x16.png">
  <link rel="manifest" href="/imagem/site.webmanifest">

  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
    onload="renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      throwOnError: false
    });"></script>
  <style>
    /* Reset horizontal overflow and prevent side scroll */
    html, body {
      overflow-x: hidden !important;
      touch-action: pan-y;
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #fff;
      color: #222;
      transition: background-color 0.3s ease, color 0.3s ease;
      overscroll-behavior-x: contain;
      font-size: 1.125rem; /* Increased base font size from 1rem to 1.125rem */
      line-height: 1.6; /* Slightly increased line height */
    }
    body.dark {
      background-color: #121212;
      color: #ddd;
    }
    #chatContainer {
      background: inherit;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      transition: background-color 0.3s ease;
      overscroll-behavior-x: contain;
    }
    header {
      background: transparent;
      border-bottom: 1px solid #e5e5e5;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      flex-shrink: 0;
      transition: border-color 0.3s ease;
      z-index: 20;
      position: relative;
    }
    body.dark header {
      border-color: #333;
    }
    header h1 {
      font-weight: 700;
      font-size: 1.75rem; /* Increased header font size */
      display: flex;
      align-items: center;
      gap: 0.5rem;
      letter-spacing: 0.05em;
      color: inherit;
      user-select: text;
    }
    #settingsBtn {
      background: transparent;
      border: none;
      color: inherit;
      font-size: 1.75rem; /* Increased settings button icon size */
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }
    #settingsBtn:hover,
    #settingsBtn:focus {
      color: #555;
      outline: none;
    }
    body.dark #settingsBtn:hover,
    body.dark #settingsBtn:focus {
      color: #bbb;
    }
    #chatMessages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1.5rem 1.5rem 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 2.5rem; /* Increased gap between messages */
      scrollbar-width: thin;
      scrollbar-color: #aaa transparent;
      scroll-behavior: smooth;
      background: inherit;
      font-size: 1rem; /* Decreased font size by 1 step from 1.125rem to 1rem */
      line-height: 1.5; /* Slightly reduced line height */
      position: relative;
      padding-bottom: 140px; /* increased padding bottom for spacing */
      word-break: break-word;
      max-width: 100%;
      transition: color 0.3s ease;
      overscroll-behavior-x: contain;
      touch-action: pan-y;
      user-select: text;
    }
    #chatMessages::-webkit-scrollbar {
      width: 8px;
    }
    #chatMessages::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 8px;
    }
    #chatMessages::-webkit-scrollbar-thumb {
      background-color: #aaa;
      border-radius: 8px;
    }
    body.dark #chatMessages::-webkit-scrollbar-thumb {
      background-color: #666;
    }
    .fade-in-up {
      animation: fadeInUp 0.3s ease forwards;
    }
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(6px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .message {
      max-width: 70ch;
      padding: 1.25rem 1.75rem; /* Increased padding */
      user-select: text;
      font-size: 1rem; /* Decreased font size by 1 step */
      line-height: 1.5; /* Slightly reduced line height */
      white-space: pre-wrap;
      overflow-wrap: break-word;
      position: relative;
      word-break: break-word;
      hyphens: auto;
      font-family: 'Inter', sans-serif;
      box-sizing: border-box;
    }
    .message.bot {
      align-self: flex-start;
      margin-left: 0 !important; /* Remove left margin to align to left border */
      margin-right: 4.5rem; /* Keep right margin for spacing */
      background: none !important;
      color: inherit;
      padding: 0;
      font-weight: 500;
      font-size: 1rem;
      line-height: 1.6;
      border-radius: 0;
      box-shadow: none;
      border: none;
      user-select: text;
      max-width: 70ch;
      /* Text floating style: no background or border, just text */
    }
    body.dark .message.bot {
      color: #ddd;
    }
    .message.user {
      align-self: flex-end;
      margin-right: 0 !important; /* Remove right margin to align to right border */
      margin-left: 4.5rem; /* Keep left margin for spacing */
      background-color: #444;
      color: #eee;
      border-top-right-radius: 0.25rem;
      border-top-left-radius: 1rem;
      border-bottom-left-radius: 1rem;
      border-bottom-right-radius: 1rem;
      padding: 1.25rem 1.75rem;
      box-sizing: border-box;
      font-size: 1rem;
      line-height: 1.5;
    }
    body.dark .message.user {
      background-color: #4f4f4f;
      color: #eee;
    }
    #inputModal {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #f5f5f5;
      padding: 0.75rem 1.25rem; /* Increased vertical and horizontal padding */
      border-radius: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem; /* Reduced gap to fit new button */
      width: 65vw;
      max-width: 550px;
      z-index: 30;
      border: 1px solid #ccc;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      flex-shrink: 0;
      box-sizing: border-box;
      max-height: 60vh;
      overflow-y: auto;
      touch-action: pan-y;
    }
    body.dark #inputModal {
      background: #2a2a2a;
      border-color: #555;
    }
    #inputModal:focus-within {
      border-color: #888;
    }
    #inputWrapper {
      flex-grow: 1;
      display: flex;
      align-items: center;
      max-width: 100%;
    }
    #pergunta {
      width: 100%;
      padding: 0.6rem 1.25rem; /* Increased padding */
      border-radius: 9999px;
      border: 1px solid #ccc;
      font-size: 1.125rem; /* Increased font size */
      color: #222;
      background-color: #fff;
      transition: border-color 0.2s ease, background-color 0.3s ease, color 0.3s ease;
      max-width: 40ch;
      white-space: nowrap; /* Prevent line breaks */
      overflow: hidden; /* Hide overflow */
      text-overflow: ellipsis; /* Show ellipsis if overflow */
      font-weight: 400;
      font-family: 'Inter', sans-serif;
      resize: none;
      line-height: 1.4;
      height: 2.75rem; /* Slightly taller base height */
      box-sizing: border-box;
    }
    #pergunta.imagem-mode {
      border-color: #2563eb;
      background-color: #dbeafe;
      color: #1e40af;
      font-weight: 600;
    }
    body.dark #pergunta {
      border-color: #555;
      background-color: #3a3a3a;
      color: #ddd;
    }
    body.dark #pergunta.imagem-mode {
      border-color: #3b82f6;
      background-color: #1e40af;
      color: #dbeafe;
      font-weight: 600;
    }
    #pergunta::placeholder {
      color: #999;
    }
    #pergunta:focus {
      outline: none;
      border-color: #888;
      background-color: #fff;
      color: #222;
      white-space: nowrap; /* Keep no line breaks on focus */
      overflow: hidden;
      text-overflow: ellipsis;
      height: 2.75rem;
      min-height: 2.75rem;
      max-height: 2.75rem;
    }
    body.dark #pergunta:focus {
      border-color: #aaa;
      background-color: #444;
      color: #eee;
    }
    #webToggleBtn {
      background-color: transparent;
      border: 1px solid #ccc;
      border-radius: 0.75rem;
      width: 40px;
      height: 40px;
      cursor: pointer;
      color: #444;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      flex-shrink: 0;
    }
    body.dark #webToggleBtn {
      border-color: #555;
      color: #ddd;
    }
    #webToggleBtn.active {
      background-color: #444;
      border-color: #444;
      color: #fff;
    }
    body.dark #webToggleBtn.active {
      background-color: #ddd;
      border-color: #ddd;
      color: #222;
    }
    #webToggleBtn:focus-visible {
      outline: 2px solid #888;
      outline-offset: 2px;
    }
    body.dark #webToggleBtn:focus-visible {
      outline: 2px solid #aaa;
      outline-offset: 2px;
    }
    #imageSelectBtn {
      background-color: transparent;
      border: 1px solid #ccc;
      border-radius: 0.75rem;
      width: 40px;
      height: 40px;
      cursor: pointer;
      color: #444;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      flex-shrink: 0;
      position: relative;
    }
    body.dark #imageSelectBtn {
      border-color: #555;
      color: #ddd;
    }
    #imageSelectBtn:focus-visible {
      outline: 2px solid #888;
      outline-offset: 2px;
    }
    body.dark #imageSelectBtn:focus-visible {
      outline: 2px solid #aaa;
      outline-offset: 2px;
    }
    #imageSelectedIndicator {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 10px;
      height: 10px;
      background-color: #10a37f;
      border-radius: 50%;
      border: 1.5px solid white;
      display: none;
      pointer-events: none;
    }
    #imageSelectedIndicator.active {
      display: block;
    }
    #enviarBtn {
      background-color: #444;
      border: none;
      color: white;
      padding: 0.6rem 1.25rem; /* Increased padding */
      border-radius: 9999px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      flex-shrink: 0;
      user-select: none;
      min-width: 44px;
      min-height: 44px; /* Increased min height */
      box-sizing: border-box;
    }
    body.dark #enviarBtn {
      background-color: #ddd;
      color: #222;
    }
    #enviarBtn:hover:not(:disabled) {
      background-color: #666;
    }
    body.dark #enviarBtn:hover:not(:disabled) {
      background-color: #bbb;
    }
    #enviarBtn:active:not(:disabled) {
      background-color: #333;
    }
    body.dark #enviarBtn:active:not(:disabled) {
      background-color: #999;
    }
    #enviarBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #settingsModal {
      position: fixed;
      top: 12vh;
      right: 1.5rem;
      height: auto;
      width: 320px;
      max-width: 90vw;
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
      padding: 1.5rem 1.5rem 2.5rem 1.5rem;
      z-index: 50;
      display: none;
      flex-direction: column;
      gap: 1rem;
      color: #222;
      user-select: none;
      font-size: 1rem;
      overflow-y: visible;
      opacity: 0;
      transform: translateX(110%);
      transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      border-radius: 1rem;
      font-family: 'Inter', sans-serif;
    }
    body.dark #settingsModal {
      background: #1e1e1e;
      border-color: #444;
      box-shadow: 0 0 20px rgb(0 0 0 / 0.6);
      color: #ddd;
    }
    #settingsModal.active {
      display: flex;
      opacity: 1;
      transform: translateX(0);
    }
    #settingsModal h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 1rem 0;
      user-select: text;
      text-align: center;
      letter-spacing: 0.05em;
    }
    #settingsModal .email-display {
      font-size: 1rem; /* Increased font size */
      background: #f5f5f5;
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      user-select: text;
      word-break: break-all;
      text-align: center;
      margin-bottom: 0;
      max-height: 3rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: 'Inter', sans-serif;
      font-weight: 400;
      border: 1px solid #ddd;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }
    body.dark #settingsModal .email-display {
      background: #2a2a2a;
      border-color: #444;
      color: #ddd;
    }
    #clearHistoryBtn, #disconnectBtn {
      background-color: #e53e3e;
      border: none;
      color: white;
      padding: 0.6rem 0.75rem; /* Increased padding */
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 700;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      font-size: 1.05rem; /* Increased font size */
      width: 100%;
      font-family: 'Inter', sans-serif;
      transition: background-color 0.2s ease;
    }
    #clearHistoryBtn:hover {
      background-color: #c53030;
    }
    #clearHistoryBtn:active {
      background-color: #9b2c2c;
    }
    #disconnectBtn {
      background-color: #444;
      color: #ddd;
      margin-top: 0.5rem;
      font-weight: 600;
    }
    body.dark #disconnectBtn {
      background-color: #555;
      color: #ddd;
    }
    #disconnectBtn:hover {
      background-color: #333;
    }
    #disconnectBtn:active {
      background-color: #222;
    }
    #settingsCloseBtn {
      position: absolute;
      top: 0.75rem;
      right: 1rem;
      background: transparent;
      border: none;
      color: inherit;
      font-size: 1.5rem;
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      z-index: 60;
    }
    #settingsCloseBtn:hover,
    #settingsCloseBtn:focus {
      color: #555;
      outline: none;
    }
    body.dark #settingsCloseBtn:hover,
    body.dark #settingsCloseBtn:focus {
      color: #bbb;
    }
    #settingsVersion {
      font-size: 0.9rem; /* Slightly increased */
      color: #666;
      text-align: center;
      user-select: text;
      margin-top: 1rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      font-family: 'Inter', sans-serif;
    }
    body.dark #settingsVersion {
      color: #999;
    }
    /* Toggle switch styles */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      display: inline-block;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 9999px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #10a37f;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    /* Responsive */
    @media (max-width: 1024px) {
      #chatContainer {
        height: 100vh;
        width: 100vw;
        max-width: 100vw;
      }
      header {
        padding: 1rem 1.25rem;
      }
      header h1 {
        font-size: 1.5rem; /* Adjusted for smaller screens */
      }
      #settingsBtn {
        font-size: 1.5rem;
      }
      #inputModal {
        width: 75vw;
        max-width: 480px;
        padding: 0.75rem 1.25rem; /* Increased padding */
        bottom: 20px;
        max-height: 50vh;
        overflow-y: auto;
      }
      #pergunta {
        font-size: 1.125rem;
        max-width: 40ch;
      }
      #webToggleBtn, #imageSelectBtn {
        width: 38px;
        height: 38px;
        font-size: 1.15rem;
      }
      #enviarBtn {
        font-size: 1.15rem;
        padding: 0.55rem 1.1rem;
        min-width: 42px;
        min-height: 38px;
      }
    }
    @media (max-width: 640px) {
      body {
        padding: 0.5rem;
        overflow-x: hidden;
      }
      #chatContainer {
        height: 100vh;
        width: 100vw;
        max-width: 100vw;
        overflow-x: hidden;
        /* Prevent horizontal scroll on mobile */
      }
      header {
        padding: 0.75rem 1rem;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: inherit;
        border-bottom: 1px solid #e5e5e5;
        z-index: 30;
      }
      body.dark header {
        border-color: #333;
      }
      header h1 {
        font-size: 1.25rem;
      }
      #settingsBtn {
        font-size: 1.3rem;
      }
      #chatMessages {
        padding: 5rem 1rem 1rem 1rem; /* Add top padding to avoid header overlap */
        font-size: 1rem; /* Decreased font size by 1 step */
        overscroll-behavior: contain;
        user-select: text;
        gap: 2rem; /* Increased gap on mobile */
      }
      .message {
        max-width: 90vw;
        font-size: 1rem; /* Decreased font size by 1 step */
        margin-left: 1.5rem !important; /* Increased margin for user and bot messages on mobile */
        margin-right: 1.5rem !important;
        padding: 1rem 1.25rem; /* Increased padding */
      }
      #inputModal {
        width: 100vw;
        max-width: 100vw;
        border-radius: 0;
        bottom: 0;
        left: 0;
        transform: none;
        padding: 0.35rem 0.85rem; /* Increased padding vertically and horizontally */
        box-shadow: none;
        border: none;
        gap: 0.35rem;
        max-height: 66px; /* Increased height by ~10px */
        overflow-y: visible;
        align-items: center;
        height: 66px; /* Increased height */
        z-index: 30;
        box-sizing: border-box;
      }
      #inputModal.mobile-expanded {
        max-height: 50vh;
        height: auto;
        padding: 0.75rem 1.25rem;
        overflow-y: auto;
        align-items: flex-start;
      }
      #pergunta {
        font-size: 1.125rem; /* Increased font size */
        padding: 0.5rem 1rem; /* Increased padding */
        max-width: 100%;
        height: 42px; /* Increased height */
        line-height: 1.3;
        resize: none;
        overflow-y: hidden;
        box-sizing: border-box;
        min-height: 42px;
        max-height: 10rem;
        white-space: nowrap; /* Prevent line breaks */
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #inputModal.mobile-expanded #pergunta {
        height: 42px;
        min-height: 42px;
        overflow-y: hidden;
      }
      #webToggleBtn, #imageSelectBtn {
        width: 36px;
        height: 36px;
        font-size: 1.1rem;
        border-radius: 0.5rem;
      }
      #enviarBtn {
        font-size: 1.15rem;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        min-width: 40px;
        min-height: 36px;
      }
      #settingsModal {
        top: 0;
        right: 0;
        width: 100vw;
        height: 100vh;
        max-width: 100vw;
        border-radius: 0;
        border: none;
        box-shadow: none;
        padding: 2rem 1.5rem 3rem 1.5rem;
        transform: translateX(100%);
        overflow-y: auto;
      }
      #settingsModal.active {
        transform: translateX(0);
      }
      #settingsCloseBtn {
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
      }
      #clearHistoryBtn, #disconnectBtn {
        font-size: 1.1rem;
      }
      #settingsVersion {
        margin-top: 1.5rem;
      }
    }
    /* Custom toast container and toast styles */
    #toastContainer {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 90vw;
      width: auto;
      pointer-events: none;
      align-items: center;
    }
    .toast {
      pointer-events: auto;
      background-color: #333;
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.3);
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      max-width: 100%;
      word-break: break-word;
      opacity: 0;
      transform: translateY(20px);
      animation: toastIn 0.3s forwards, toastOut 0.3s forwards 3.7s;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .toast.success {
      background-color: #10a37f;
    }
    .toast.error {
      background-color: #e53e3e;
    }
    .toast .close-btn {
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
      color: white;
      background: transparent;
      border: none;
      padding: 0;
      margin-left: auto;
      user-select: none;
      transition: color 0.2s ease;
    }
    .toast .close-btn:hover,
    .toast .close-btn:focus {
      color: #ddd;
      outline: none;
    }
    @keyframes toastIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes toastOut {
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }
    /* Image message styling */
    .message.bot img.generated-image {
      max-width: 100%;
      height: auto;
      border-radius: 1rem;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
      user-select: none;
      pointer-events: auto;
      display: block;
      margin-top: 0.25rem;
      cursor: pointer;
      transition: box-shadow 0.2s ease;
    }
    .message.bot img.generated-image:hover {
      box-shadow: 0 6px 14px rgb(0 0 0 / 0.3);
    }
    /* Modal overlay for image preview */
    #imagePreviewOverlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100000;
      padding: 1rem;
      box-sizing: border-box;
    }
    #imagePreviewOverlay.active {
      display: flex;
    }
    #imagePreviewContent {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 0 20px rgb(0 0 0 / 0.5);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    body.dark #imagePreviewContent {
      background: #222;
    }
    #imagePreviewContent img {
      max-width: 100%;
      max-height: 80vh;
      display: block;
      border-bottom: 1px solid #ccc;
    }
    body.dark #imagePreviewContent img {
      border-color: #444;
    }
    #imagePreviewActions {
      display: flex;
      justify-content: flex-end;
      padding: 0.5rem 1rem;
      gap: 1rem;
      width: 100%;
      background: #f5f5f5;
    }
    body.dark #imagePreviewActions {
      background: #2a2a2a;
    }
    #imagePreviewActions button {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      color: #444;
      transition: color 0.2s ease;
      user-select: none;
    }
    body.dark #imagePreviewActions button {
      color: #ddd;
    }
    #imagePreviewActions button:hover,
    #imagePreviewActions button:focus {
      color: #10a37f;
      outline: none;
    }
    /* Custom styles for /imagem message formatting */
    .imagem-command {
      color: #2563eb;
      font-weight: 600;
      user-select: text;
    }
    .imagem-prompt {
      color: #fff;
      font-weight: 700;
      user-select: text;
    }
    body.dark .imagem-prompt {
      color: #f0f9ff;
    }
    /* KaTeX overrides for dark mode */
    body.dark .katex {
      color: #ddd !important;
    }
    body.dark .katex .katex-html {
      color: #ddd !important;
    }
    /* Image preview in chat for ask_gemini */
    .message.bot .image-question-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 70ch;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
      background-color: #f0f0f0;
      padding: 1rem;
      user-select: text;
    }
    body.dark .message.bot .image-question-wrapper {
      background-color: #2a2a2a;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.4);
    }
    .message.bot .image-question-wrapper img {
      max-width: 100%;
      border-radius: 1rem;
      cursor: pointer;
      user-select: none;
      pointer-events: auto;
      transition: box-shadow 0.2s ease;
    }
    .message.bot .image-question-wrapper img:hover {
      box-shadow: 0 6px 14px rgb(0 0 0 / 0.3);
    }
    .message.bot .image-question-wrapper .question-text {
      font-weight: 500;
      font-size: 1rem;
      color: inherit;
      white-space: pre-wrap;
      word-break: break-word;
    }
    /* User image question wrapper */
    .message.user .image-question-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 70ch;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
      background-color: #444;
      padding: 1rem;
      user-select: text;
      color: #eee;
    }
    body.dark .message.user .image-question-wrapper {
      background-color: #4f4f4f;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.4);
    }
    .message.user .image-question-wrapper img {
      max-width: 100%;
      border-radius: 1rem;
      cursor: pointer;
      user-select: none;
      pointer-events: auto;
      transition: box-shadow 0.2s ease;
    }
    .message.user .image-question-wrapper img:hover {
      box-shadow: 0 6px 14px rgb(0 0 0 / 0.3);
    }
    .message.user .image-question-wrapper .question-text {
      font-weight: 600;
      font-size: 1rem;
      color: #dbeafe;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div id="chatContainer" role="main" aria-label="Chat ZIPPY Interface Simples">
    <header>
      <h1>
        ZIPPY
      </h1>
      <button id="settingsBtn" aria-label="Abrir configurações" title="Configurações" type="button">
        <i class="fas fa-cog" aria-hidden="true"></i>
      </button>
      <nav aria-label="Ações do chat" hidden>
      </nav>
    </header>

    <main id="chatMessages" role="log" aria-live="polite" aria-relevant="additions" tabindex="0">
    </main>

    <form id="inputModal" autocomplete="off" onsubmit="return false" aria-label="Enviar mensagem">
      <button
        id="webToggleBtn"
        type="button"
        aria-pressed="false"
        aria-label="Ativar pesquisa na web"
        title="Ativar pesquisa na web"
        tabindex="0"
      >
        <i class="fas fa-globe-americas"></i>
      </button>
      <button
        id="imageSelectBtn"
        type="button"
        aria-label="Selecionar imagem para enviar"
        title="Selecionar imagem para enviar"
        tabindex="0"
      >
        <i class="fas fa-image"></i>
        <span id="imageSelectedIndicator" aria-hidden="true"></span>
      </button>
      <input type="file" id="imageInput" accept="image/*" style="display:none" aria-hidden="true" />
      <div id="inputWrapper">
        <textarea
          id="pergunta"
          placeholder="Digite sua mensagem..."
          aria-label="Digite sua mensagem"
          spellcheck="false"
          autocomplete="off"
          maxlength="4000"
          autofocus
          aria-disabled="true"
          tabindex="0"
          rows="1"
          style="resize:none; overflow:hidden;"
        ></textarea>
      </div>
      <button id="enviarBtn" type="submit" aria-label="Enviar mensagem" disabled tabindex="0">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>

    <section id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" tabindex="-1">
      <button id="settingsCloseBtn" aria-label="Fechar configurações" title="Fechar configurações" type="button">
        <i class="fas fa-times"></i>
      </button>
      <h2 id="settingsTitle">ZIPPY</h2>
      <div id="userEmail" class="email-display" tabindex="0" aria-readonly="true"></div>
      <button id="clearHistoryBtn" type="button" aria-label="Limpar histórico de mensagens" title="Limpar histórico de mensagens">
        <i class="fas fa-trash-alt"></i> Limpar histórico
      </button>

      <label for="themeToggleSwitch" class="flex items-center cursor-pointer select-none gap-2">
        <span>Tema claro</span>
        <div class="toggle-switch">
          <input type="checkbox" id="themeToggleSwitch" aria-label="Alternar tema claro/escuro" />
          <span class="slider"></span>
        </div>
        <span>Escuro</span>
      </label>

      <button id="disconnectBtn" type="button" aria-label="Desconectar da conta" title="Desconectar da conta">
        <i class="fas fa-sign-out-alt"></i> Desconectar
      </button>
      <div id="settingsVersion">B.1.0.0</div>
    </section>

    <div id="toastContainer" aria-live="assertive" aria-atomic="true"></div>
  </div>

  <!-- Image preview modal -->
  <div id="imagePreviewOverlay" role="dialog" aria-modal="true" aria-label="Visualizador de imagem">
    <div id="imagePreviewContent">
      <img id="imagePreviewImg" src="" alt="Visualização da imagem gerada em tamanho real" />
      <div id="imagePreviewActions">
        <button id="downloadImageBtn" aria-label="Baixar imagem" title="Baixar imagem">
          <i class="fas fa-download"></i>
        </button>
        <button id="closeImagePreviewBtn" aria-label="Fechar visualizador" title="Fechar visualizador">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Toast system to replace alert()
    const toastContainer = document.getElementById('toastContainer');

    function showToast(message, type = 'error', duration = 4000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');

      const msgSpan = document.createElement('span');
      msgSpan.textContent = message;
      toast.appendChild(msgSpan);

      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-btn';
      closeBtn.setAttribute('aria-label', 'Fechar notificação');
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = () => {
        toastContainer.removeChild(toast);
      };
      toast.appendChild(closeBtn);

      toastContainer.appendChild(toast);

      setTimeout(() => {
        if (toast.parentNode) {
          toast.classList.add('hide');
          toast.addEventListener('animationend', () => {
            if (toast.parentNode) toastContainer.removeChild(toast);
          });
        }
      }, duration);
    }

    // Redirect user to login page if not logged in
    function redirectToLogin() {
      // Detect if device is mobile or desktop
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (isMobile) {
        window.location.href = 'https://zippy.icu/loginv1';
      } else {
        window.location.href = 'https://zippy.icu/loginv2';
      }
    }

    // IndexedDB helper functions
    const dbName = "ZippyChatDB";
    const storeName = "messages";

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(storeName)) {
            const store = db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
            store.createIndex("userId", "userId", { unique: false });
          }
        };
      });
    }

    async function getMessages(userId) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readonly");
        const store = tx.objectStore(storeName);
        const index = store.index("userId");
        const request = index.getAll(IDBKeyRange.only(userId));
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function saveMessages(userId, messages) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readwrite");
        const store = tx.objectStore(storeName);
        // First clear existing messages for user
        const index = store.index("userId");
        const getAllKeysRequest = index.getAllKeys(IDBKeyRange.only(userId));
        getAllKeysRequest.onsuccess = () => {
          const keys = getAllKeysRequest.result;
          keys.forEach(key => store.delete(key));
          // After clearing, add new messages
          messages.forEach(msg => {
            store.add({ userId, html: msg.html, fromUser: msg.fromUser });
          });
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        };
        getAllKeysRequest.onerror = () => reject(getAllKeysRequest.error);
      });
    }

    async function clearMessages(userId) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readwrite");
        const store = tx.objectStore(storeName);
        const index = store.index("userId");
        const getAllKeysRequest = index.getAllKeys(IDBKeyRange.only(userId));
        getAllKeysRequest.onsuccess = () => {
          const keys = getAllKeysRequest.result;
          keys.forEach(key => store.delete(key));
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        };
        getAllKeysRequest.onerror = () => reject(getAllKeysRequest.error);
      });
    }

    // Retry helper with 2 attempts max, then throw error
    async function retryFetch(fn, retries = 2, delay = 700) {
      let lastError;
      for (let attempt = 0; attempt <= retries; attempt++) {
        try {
          return await fn();
        } catch (err) {
          lastError = err;
          if (attempt < retries) {
            await new Promise(r => setTimeout(r, delay));
          }
        }
      }
      throw lastError;
    }

    // Check user login on load
    window.addEventListener('load', async () => {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.id || !user.email) {
        redirectToLogin();
        return;
      }
      adjustInputModalForMobile();
      const inputModal = document.getElementById('inputModal');
      const chatMessages = document.getElementById('chatMessages');
      if (inputModal && chatMessages) {
        const inputRect = inputModal.getBoundingClientRect();
        chatMessages.style.paddingBottom = `${inputRect.height + 60}px`;
      }
      await loadMessagesFromStorage();
      loadUserEmail();
      loadThemeFromStorage();
      autoResizeTextarea();
    });

    // Adjust input modal height and position for desktop and mobile devices
    function adjustInputModalForMobile() {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const inputModal = document.getElementById('inputModal');
      if (!inputModal) return;

      if (isMobile) {
        inputModal.classList.remove('mobile-expanded');
        inputModal.style.bottom = '0';
        inputModal.style.left = '0';
        inputModal.style.transform = 'none';
        inputModal.style.width = '100vw';
        inputModal.style.maxWidth = '100vw';
        inputModal.style.borderRadius = '0';
        inputModal.style.padding = '0.35rem 0.85rem';
        inputModal.style.height = '66px';
        inputModal.style.maxHeight = '66px';
        inputModal.style.overflowY = 'visible';
        inputModal.style.alignItems = 'center';
      } else {
        inputModal.classList.add('mobile-expanded');
        inputModal.style.bottom = '20px';
        inputModal.style.left = '50%';
        inputModal.style.transform = 'translateX(-50%)';
        inputModal.style.width = '65vw';
        inputModal.style.maxWidth = '550px';
        inputModal.style.borderRadius = '1.5rem';
        inputModal.style.padding = '0.75rem 1.25rem';
        inputModal.style.height = 'auto';
        inputModal.style.maxHeight = '60vh';
        inputModal.style.overflowY = 'auto';
        inputModal.style.alignItems = 'flex-start';
      }
    }

    // Recalculate chatMessages padding-bottom on window resize and orientation change
    function updateChatMessagesPadding() {
      const inputModal = document.getElementById('inputModal');
      const chatMessages = document.getElementById('chatMessages');
      if (inputModal && chatMessages) {
        const inputRect = inputModal.getBoundingClientRect();
        chatMessages.style.paddingBottom = `${inputRect.height + 60}px`;
      }
    }

    window.addEventListener('resize', () => {
      adjustInputModalForMobile();
      updateChatMessagesPadding();
    });

    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        adjustInputModalForMobile();
        updateChatMessagesPadding();
      }, 300);
    });

    const chatMessages = document.getElementById("chatMessages");
    const perguntaInput = document.getElementById("pergunta");
    const enviarBtn = document.getElementById("enviarBtn");
    const webToggleBtn = document.getElementById("webToggleBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsModal = document.getElementById("settingsModal");
    const settingsCloseBtn = document.getElementById("settingsCloseBtn");
    const userEmailDisplay = document.getElementById("userEmail");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const themeToggleSwitch = document.getElementById("themeToggleSwitch");
    const body = document.body;

    const imagePreviewOverlay = document.getElementById("imagePreviewOverlay");
    const imagePreviewImg = document.getElementById("imagePreviewImg");
    const downloadImageBtn = document.getElementById("downloadImageBtn");
    const closeImagePreviewBtn = document.getElementById("closeImagePreviewBtn");

    const imageSelectBtn = document.getElementById("imageSelectBtn");
    const imageInput = document.getElementById("imageInput");
    const imageSelectedIndicator = document.getElementById("imageSelectedIndicator");

    let isTypingResponse = false;
    let isImagemMode = false;
    let currentImageDataURI = null;

    // New state for selected image for ask_gemini
    let selectedImageFile = null;

    // Helper: Convert File to base64 string
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error("Erro ao ler arquivo"));
        reader.readAsDataURL(file);
      });
    }

    async function loadMessagesFromStorage() {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.id || !user.email) return;
      try {
        const messages = await getMessages(user.id);
        if (messages.length === 0) {
          const data = await retryFetch(async () => {
            const response = await fetch(`https://api-zylo.doshi.icu/historico?email=${encodeURIComponent(user.email)}`);
            if (!response.ok) throw new Error(`Erro ao buscar histórico! Status: ${response.status}`);
            return response.json();
          }, 2, 700);
          if (data && Array.isArray(data.historico)) {
            const msgs = data.historico.map(item => {
              if (item.role === "user" && item.html && item.html.includes('image-question-wrapper')) {
                return {
                  html: item.html,
                  fromUser: true
                };
              } else if (item.role === "user" && item.text && item.text.toLowerCase().startsWith("/imagem")) {
                const html = parseMarkdown(item.text);
                return {
                  html: html,
                  fromUser: true
                };
              } else if (item.role === "user") {
                const html = parseMarkdown(item.text);
                return {
                  html: html,
                  fromUser: true
                };
              } else {
                if (item.html && item.html.includes('<img')) {
                  return {
                    html: item.html,
                    fromUser: false
                  };
                } else {
                  const html = parseMarkdown(item.text);
                  return {
                    html: html,
                    fromUser: false
                  };
                }
              }
            });
            await saveMessages(user.id, msgs);
            msgs.forEach(({ html, fromUser }) => {
              addMessageFromHTML(html, fromUser, false);
            });
          }
        } else {
          messages.forEach(({ html, fromUser }) => {
            addMessageFromHTML(html, fromUser, false);
          });
        }
        attachImagePreviewHandlers();
        setTimeout(() => {
          chatMessages.scrollTop = chatMessages.scrollHeight;
          renderMathInElement(chatMessages, {
            delimiters: [
              { left: '$$', right: '$$', display: true },
              { left: '\\[', right: '\\]', display: true },
              { left: '$', right: '$', display: false },
              { left: '\\(', right: '\\)', display: false }
            ],
            throwOnError: false
          });
        }, 50);
      } catch (error) {
        console.error("Erro ao carregar histórico:", error);
        showToast("Erro ao carregar histórico.", "error");
      }
    }

    async function saveMessagesToStorage() {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.id) return;
      const messages = [];
      const messageElements = chatMessages.querySelectorAll(".message");
      for (const msgEl of messageElements) {
        const fromUser = msgEl.classList.contains("user");
        if (fromUser) {
          const img = msgEl.querySelector("img");
          if (img && img.src) {
            // Store the message HTML as is, including image src (base64 or URL)
            messages.push({ html: msgEl.innerHTML, fromUser });
            continue;
          }
        }
        messages.push({ html: msgEl.innerHTML, fromUser });
      }
      try {
        await saveMessages(user.id, messages);
      } catch (error) {
        console.error("Erro ao salvar mensagens no IndexedDB:", error);
      }
    }

    webToggleBtn.addEventListener("click", () => {
      if (isTypingResponse) return;
      const active = webToggleBtn.classList.toggle("active");
      webToggleBtn.setAttribute("aria-pressed", active ? "true" : "false");
      updateEnviarBtnState();
    });

    imageSelectBtn.addEventListener("click", () => {
      if (isTypingResponse) return;
      imageInput.click();
    });

    imageInput.addEventListener("change", () => {
      if (imageInput.files && imageInput.files[0]) {
        selectedImageFile = imageInput.files[0];
        imageSelectedIndicator.classList.add("active");
        updateEnviarBtnState();
      } else {
        selectedImageFile = null;
        imageSelectedIndicator.classList.remove("active");
        updateEnviarBtnState();
      }
    });

    function updateEnviarBtnState() {
      const val = perguntaInput.value.trim();
      if ((val.length === 0 && !selectedImageFile) || val.length > 4000 || isTypingResponse) {
        enviarBtn.disabled = true;
        perguntaInput.setAttribute("aria-disabled", "true");
      } else {
        enviarBtn.disabled = false;
        perguntaInput.setAttribute("aria-disabled", "false");
      }
    }

    perguntaInput.addEventListener("input", () => {
      autoResizeTextarea();
      const val = perguntaInput.value.trim();
      if (val.toLowerCase().startsWith("/imagem")) {
        isImagemMode = true;
        perguntaInput.classList.add("imagem-mode");
      } else {
        isImagemMode = false;
        perguntaInput.classList.remove("imagem-mode");
      }
      updateEnviarBtnState();
    });

    function autoResizeTextarea() {
      const ta = perguntaInput;
      const inputWrapper = document.getElementById('inputWrapper');
      ta.style.height = 'auto';
      ta.style.width = '100%';
      ta.style.height = '2.75rem';
    }

    function resetTextareaHeight() {
      const ta = perguntaInput;
      ta.style.height = '2.75rem';
      ta.style.overflowY = 'hidden';
    }

    perguntaInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (!enviarBtn.disabled) {
          sendMessage();
        }
      }
      if (e.key === "Enter" && e.shiftKey) {
        e.preventDefault();
      }
    });

    function parseMarkdown(text) {
      const escapeHtml = (str) =>
        str.replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#39;");

      let escapedText = escapeHtml(text);

      escapedText = escapedText.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      escapedText = escapedText.replace(/\*(.+?)\*/g, '<em>$1</em>');
      escapedText = escapedText.replace(/\\n/g, '<br>');

      return escapedText;
    }

    function addMessage(text, fromUser = false, save = true) {
      const messageWrapper = document.createElement("div");
      messageWrapper.classList.add("fade-in-up", "message");
      if (fromUser) {
        messageWrapper.classList.add("user");
        if (text.toLowerCase().startsWith("/imagem")) {
          const prompt = text.substring(7).trim();
          const spanCommand = document.createElement("span");
          spanCommand.className = "imagem-command";
          spanCommand.textContent = "imagem";
          const spanPrompt = document.createElement("span");
          spanPrompt.className = "imagem-prompt";
          spanPrompt.textContent = prompt ? " " + prompt : "";
          messageWrapper.appendChild(spanCommand);
          messageWrapper.appendChild(spanPrompt);
        } else {
          messageWrapper.textContent = text;
        }
      } else {
        messageWrapper.classList.add("bot");
        messageWrapper.innerHTML = parseMarkdown(text);
      }
      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      if (save) saveMessagesToStorage();
      if (!fromUser) {
        renderMathInElement(messageWrapper, {
          delimiters: [
            { left: '$$', right: '$$', display: true },
            { left: '\\[', right: '\\]', display: true },
            { left: '$', right: '$', display: false },
            { left: '\\(', right: '\\)', display: false }
          ],
          throwOnError: false
        });
      }
    }

    function addMessageFromHTML(html, fromUser = false, save = true) {
      const messageWrapper = document.createElement("div");
      messageWrapper.classList.add("fade-in-up", "message");
      if (fromUser) {
        messageWrapper.classList.add("user");
        messageWrapper.innerHTML = html;
      } else {
        messageWrapper.classList.add("bot");
        messageWrapper.innerHTML = html;
      }
      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      if (save) saveMessagesToStorage();
      if (!fromUser) {
        renderMathInElement(messageWrapper, {
          delimiters: [
            { left: '$$', right: '$$', display: true },
            { left: '\\[', right: '\\]', display: true },
            { left: '$', right: '$', display: false },
            { left: '\\(', right: '\\)', display: false }
          ],
          throwOnError: false
        });
      }
    }

    async function typeMessage(text) {
      isTypingResponse = true;
      updateEnviarBtnState();

      const messageWrapper = document.createElement("div");
      messageWrapper.classList.add("fade-in-up", "message", "bot");

      messageWrapper.innerHTML = parseMarkdown(text);

      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      await saveMessagesToStorage();

      await new Promise(resolve => setTimeout(resolve, 50));

      renderMathInElement(messageWrapper, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '\\[', right: '\\]', display: true },
          { left: '$', right: '$', display: false },
          { left: '\\(', right: '\\)', display: false }
        ],
        throwOnError: false
      });

      isTypingResponse = false;
      updateEnviarBtnState();
    }

    function addImageMessage(imageDataURI) {
      const messageWrapper = document.createElement("div");
      messageWrapper.classList.add("fade-in-up", "message", "bot");

      const img = document.createElement("img");
      img.src = imageDataURI;
      img.alt = "Imagem gerada automaticamente pelo ZIPPY com resolução 1024x1024 pixels, exibida em tamanho reduzido para melhor visualização no chat.";
      img.classList.add("generated-image");
      img.style.maxWidth = "320px";
      img.style.height = "auto";

      img.addEventListener("click", () => {
        openImagePreview(imageDataURI);
      });

      messageWrapper.appendChild(img);
      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      saveMessagesToStorage();
    }

    function attachImagePreviewHandlers() {
      // Remove all previous listeners by replacing nodes
      const images = chatMessages.querySelectorAll(".message.bot img.generated-image, .message.user .image-question-wrapper img");
      images.forEach(img => {
        const newImg = img.cloneNode(true);
        img.parentNode.replaceChild(newImg, img);
      });
      // Re-attach listeners
      const newImages = chatMessages.querySelectorAll(".message.bot img.generated-image, .message.user .image-question-wrapper img");
      newImages.forEach(img => {
        img.addEventListener("click", () => {
          openImagePreview(img.src);
        });
      });
    }

    async function gerarImagem(email, prompt) {
      const url = 'https://api-zylo.doshi.icu/generate-image';

      return retryFetch(async () => {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, prompt })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || 'Erro ao gerar a imagem');
        }

        const data = await response.json();
        if (data.image) {
          return data.image;
        } else {
          throw new Error('Nenhuma imagem retornada da API.');
        }
      }, 2, 700);
    }

    async function sendChatMessage(email, pergunta, web) {
      return retryFetch(async () => {
        const payload = {
          email: email,
          pergunta: pergunta,
          web: web,
        };

        const response = await fetch("https://api-zylo.doshi.icu/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`Erro na requisição! Status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      }, 2, 700);
    }

    async function sendAskGeminiMessage(email, question, imageFile) {
      return retryFetch(async () => {
        if (!imageFile) {
          throw new Error("Imagem não fornecida para análise.");
        }
        const formData = new FormData();
        formData.append('email', email);
        formData.append('question', question);
        formData.append('image', imageFile);

        const response = await fetch("https://api-zylo.doshi.icu/ask_gemini/", {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          throw new Error(`Erro na requisição! Status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      }, 2, 700);
    }

    async function sendMessage() {
      if (isTypingResponse) return;

      let pergunta = perguntaInput.value.trim();
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.email) {
        showToast("Usuário não encontrado no localStorage.", "error");
        enviarBtn.disabled = false;
        return;
      }
      const email = user.email;

      if (selectedImageFile) {
        if (!pergunta) {
          showToast("Por favor, digite uma pergunta para a imagem selecionada.", "error");
          return;
        }
        // Convert selected image file to base64 for persistent storage
        const base64Image = await fileToBase64(selectedImageFile);
        addUserImageQuestionMessage(base64Image, pergunta);
        perguntaInput.value = "";
        selectedImageFile = null;
        imageSelectedIndicator.classList.remove("active");
        updateEnviarBtnState();
        resetTextareaHeight();

        const loadingMessage = document.createElement("div");
        loadingMessage.classList.add("fade-in-up", "message", "bot");
        loadingMessage.textContent = "Analisando imagem...";
        chatMessages.appendChild(loadingMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        await saveMessagesToStorage();

        try {
          const data = await sendAskGeminiMessage(email, pergunta, imageInput.files[0]);
          chatMessages.removeChild(loadingMessage);
          if (data.answer) {
            await typeMessage(data.answer);
          } else {
            await typeMessage("Sem resposta da API.");
          }
        } catch (err) {
          chatMessages.removeChild(loadingMessage);
          await typeMessage("Erro ao conectar com a API.");
          showToast("Erro ao conectar com a API: " + err.message, "error");
        } finally {
          enviarBtn.disabled = false;
          await saveMessagesToStorage(); // Save updated messages including image question and answer
          attachImagePreviewHandlers();
        }
      } else if (isImagemMode) {
        const prompt = pergunta.replace(/^\/imagem\s*/i, '').trim();
        if (!prompt) {
          showToast("Por favor, digite um prompt após /imagem.", "error");
          return;
        }
        addMessage(pergunta, true);
        perguntaInput.value = "";
        isImagemMode = false;
        perguntaInput.classList.remove("imagem-mode");
        updateEnviarBtnState();
        enviarBtn.disabled = true;
        resetTextareaHeight();

        const loadingMessage = document.createElement("div");
        loadingMessage.classList.add("fade-in-up", "message", "bot");
        loadingMessage.textContent = "Gerando imagem...";
        chatMessages.appendChild(loadingMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        await saveMessagesToStorage();

        try {
          const imageDataURI = await gerarImagem(email, prompt);
          chatMessages.removeChild(loadingMessage);
          addImageMessage(imageDataURI);
          attachImagePreviewHandlers();
        } catch (err) {
          chatMessages.removeChild(loadingMessage);
          await typeMessage("Erro ao gerar a imagem.");
          showToast("Erro ao gerar a imagem: " + err.message, "error");
        } finally {
          enviarBtn.disabled = false;
          await saveMessagesToStorage(); // Save updated messages including generated image
        }
      } else {
        if (!pergunta) {
          showToast("Por favor, digite uma pergunta.", "error");
          return;
        }
        addMessage(pergunta, true);
        perguntaInput.value = "";
        updateEnviarBtnState();
        enviarBtn.disabled = true;
        resetTextareaHeight();

        const web = webToggleBtn.classList.contains("active") ? "on" : "off";

        const loadingMessage = document.createElement("div");
        loadingMessage.classList.add("fade-in-up", "message", "bot");
        loadingMessage.textContent = web === "on" ? "Buscando na web..." : "Pensando...";
        chatMessages.appendChild(loadingMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        await saveMessagesToStorage();

        try {
          const data = await sendChatMessage(email, pergunta, web);

          chatMessages.removeChild(loadingMessage);
          await saveMessagesToStorage();

          await typeMessage(data.resposta || "Sem resposta.");
        } catch (err) {
          console.error("Erro:", err);

          chatMessages.removeChild(loadingMessage);
          await saveMessagesToStorage();

          await typeMessage("Erro ao conectar com a API.");
          showToast("Erro ao conectar com a API: " + err.message, "error");
        } finally {
          enviarBtn.disabled = false;
        }
      }
    }

    function addUserImageQuestionMessage(imageDataURI, question) {
      const messageWrapper = document.createElement("div");
      messageWrapper.classList.add("fade-in-up", "message", "user");

      const container = document.createElement("div");
      container.className = "image-question-wrapper";

      const img = document.createElement("img");
      img.src = imageDataURI;
      img.alt = "Imagem selecionada pelo usuário para análise pelo ZIPPY.";
      img.style.maxWidth = "320px";
      img.style.height = "auto";
      img.style.borderRadius = "1rem";
      img.style.userSelect = "none";
      img.style.pointerEvents = "auto";
      img.style.cursor = "pointer";
      img.addEventListener("click", () => {
        openImagePreview(imageDataURI);
      });

      const questionText = document.createElement("div");
      questionText.className = "question-text";
      questionText.textContent = question;

      container.appendChild(img);
      container.appendChild(questionText);
      messageWrapper.appendChild(container);

      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      saveMessagesToStorage();
    }

    function openImagePreview(imageDataURI) {
      currentImageDataURI = imageDataURI;
      imagePreviewImg.src = imageDataURI;
      imagePreviewOverlay.classList.add("active");
      imagePreviewOverlay.focus();
    }

    function closeImagePreview() {
      imagePreviewOverlay.classList.remove("active");
      imagePreviewImg.src = "";
      currentImageDataURI = null;
    }

    downloadImageBtn.addEventListener("click", () => {
      if (!currentImageDataURI) return;
      fetch(currentImageDataURI)
        .then(res => res.blob())
        .then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const now = new Date();
          const timestamp = now.toISOString().replace(/[:.]/g, '-');
          a.download = `zippy-generate.${timestamp}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        })
        .catch(() => {
          showToast("Erro ao baixar a imagem.", "error");
        });
    });

    closeImagePreviewBtn.addEventListener("click", () => {
      closeImagePreview();
    });

    imagePreviewOverlay.addEventListener("click", (e) => {
      if (e.target === imagePreviewOverlay) {
        closeImagePreview();
      }
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && imagePreviewOverlay.classList.contains("active")) {
        e.preventDefault();
        closeImagePreview();
      }
    });

    function customConfirm(message) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = 0;
        overlay.style.left = 0;
        overlay.style.width = '100vw';
        overlay.style.height = '100vh';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.3)';
        overlay.style.zIndex = 1000;
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';

        const modal = document.createElement('div');
        modal.style.backgroundColor = body.classList.contains('dark') ? '#2a2a2a' : '#fff';
        modal.style.padding = '1.5rem 2rem';
        modal.style.borderRadius = '1rem';
        modal.style.boxShadow = '0 0 15px rgb(0 0 0 / 0.15)';
        modal.style.maxWidth = '320px';
        modal.style.width = '90vw';
        modal.style.color = body.classList.contains('dark') ? '#ddd' : '#222';
        modal.style.fontFamily = "'Inter', sans-serif";
        modal.style.textAlign = 'center';
        modal.style.userSelect = 'none';
        modal.style.fontWeight = '600';

        const msg = document.createElement('p');
        msg.textContent = message;
        msg.style.marginBottom = '1.5rem';
        msg.style.fontSize = '1rem';
        modal.appendChild(msg);

        const btnContainer = document.createElement('div');
        btnContainer.style.display = 'flex';
        btnContainer.style.justifyContent = 'center';
        btnContainer.style.gap = '1rem';

        const btnConfirm = document.createElement('button');
        btnConfirm.textContent = 'Sim';
        btnConfirm.style.backgroundColor = '#10a37f';
        btnConfirm.style.color = 'white';
        btnConfirm.style.border = 'none';
        btnConfirm.style.padding = '0.5rem 1.25rem';
        btnConfirm.style.borderRadius = '0.5rem';
        btnConfirm.style.cursor = 'pointer';
        btnConfirm.style.fontWeight = '700';
        btnConfirm.style.fontFamily = "'Inter', sans-serif";
        btnConfirm.addEventListener('mouseenter', () => {
          btnConfirm.style.backgroundColor = '#0e8f6e';
        });
        btnConfirm.addEventListener('mouseleave', () => {
          btnConfirm.style.backgroundColor = '#10a37f';
        });

        const btnCancel = document.createElement('button');
        btnCancel.textContent = 'Não';
        btnCancel.style.backgroundColor = '#e53e3e';
        btnCancel.style.color = 'white';
        btnCancel.style.border = 'none';
        btnCancel.style.padding = '0.5rem 1.25rem';
        btnCancel.style.borderRadius = '0.5rem';
        btnCancel.style.cursor = 'pointer';
        btnCancel.style.fontWeight = '700';
        btnCancel.style.fontFamily = "'Inter', sans-serif";
        btnCancel.addEventListener('mouseenter', () => {
          btnCancel.style.backgroundColor = '#c53030';
        });
        btnCancel.addEventListener('mouseleave', () => {
          btnCancel.style.backgroundColor = '#e53e3e';
        });

        btnConfirm.addEventListener('click', () => {
          document.body.removeChild(overlay);
          resolve(true);
        });
        btnCancel.addEventListener('click', () => {
          document.body.removeChild(overlay);
          resolve(false);
        });

        btnContainer.appendChild(btnConfirm);
        btnContainer.appendChild(btnCancel);
        modal.appendChild(btnContainer);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        btnConfirm.focus();

        function onKeyDown(e) {
          if (e.key === "Escape") {
            e.preventDefault();
            document.body.removeChild(overlay);
            resolve(false);
            window.removeEventListener('keydown', onKeyDown);
          }
        }
        window.addEventListener('keydown', onKeyDown);
      });
    }

    enviarBtn.addEventListener("click", (e) => {
      e.preventDefault();
      sendMessage();
    });

    const observer = new MutationObserver(() => {
      updateChatMessagesPadding();
    });
    observer.observe(document.getElementById('chatMessages'), { childList: true, subtree: true });

    window.addEventListener('resize', () => {
      adjustInputModalForMobile();
      updateChatMessagesPadding();
    });

    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        adjustInputModalForMobile();
        updateChatMessagesPadding();
      }, 300);
    });

    function openSettings() {
      settingsModal.classList.add("active");
      settingsModal.focus();
    }
    function closeSettings() {
      settingsModal.classList.remove("active");
      settingsBtn.focus();
    }

    settingsBtn.addEventListener("click", () => {
      if (settingsModal.classList.contains("active")) {
        closeSettings();
      } else {
        openSettings();
      }
    });

    settingsCloseBtn.addEventListener("click", () => {
      closeSettings();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && settingsModal.classList.contains("active")) {
        e.preventDefault();
        closeSettings();
      }
    });

    function loadUserEmail() {
      const user = JSON.parse(localStorage.getItem("user"));
      if (user && user.email) {
        userEmailDisplay.textContent = user.email;
      } else {
        userEmailDisplay.textContent = "Usuário não encontrado";
      }
    }

    clearHistoryBtn.addEventListener("click", async () => {
      const confirmed = await customConfirm("Tem certeza que deseja limpar o histórico de mensagens?");
      if (!confirmed) return;

      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.email || !user.id) {
        showToast("Usuário não encontrado no localStorage.", "error");
        return;
      }
      try {
        const email = encodeURIComponent(user.email);
        await retryFetch(async () => {
          const response = await fetch(`https://api-zylo.doshi.icu/apagar-historico?email=${email}`, {
            method: "DELETE",
          });
          if (!response.ok) {
            throw new Error(`Erro ao apagar histórico! Status: ${response.status}`);
          }
        }, 2, 700);
        await clearMessages(user.id);
        while (chatMessages.firstChild) {
          chatMessages.removeChild(chatMessages.firstChild);
        }
        closeSettings();
        showToast("Histórico apagado com sucesso.", "success");
      } catch (error) {
        showToast("Erro ao apagar histórico: " + error.message, "error");
      }
    });

    disconnectBtn.addEventListener("click", async () => {
      const confirmed = await customConfirm("Tem certeza que deseja desconectar da conta?");
      if (!confirmed) return;

      localStorage.removeItem("user");
      redirectToLogin();
    });

    function setTheme(dark) {
      if (dark) {
        body.classList.add('dark');
        themeToggleSwitch.checked = true;
        localStorage.setItem('theme', 'dark');
      } else {
        body.classList.remove('dark');
        themeToggleSwitch.checked = false;
        localStorage.setItem('theme', 'light');
      }
    }

    function loadThemeFromStorage() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        setTheme(true);
      } else {
        setTheme(false);
      }
    }

    themeToggleSwitch.addEventListener('change', () => {
      setTheme(themeToggleSwitch.checked);
    });

    updateEnviarBtnState();
  </script>
</body>
</html>
